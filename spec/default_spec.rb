# -*- coding: utf-8 -*-

require 'chefspec'
require 'chefspec/berkshelf'

describe 'pentestenv::default' do
  let(:subject) do
    ChefSpec::SoloRunner.new(step_into: %w(pentestenv_pentestrc),
                             platform: 'debian',
                             version: '9.11') do |node|
      node.override['pentestenv']['user'] = 'elliot'
      node.override['pentestenv']['install_dir'] = '/opt/pentest-env'
      node.override['pentestenv']['custom_berksfile']['cookbook'] = 'pentestenv'
      node.override['pentestenv']['custom_berksfile']['file'] = 'pentestd'
      node.override['pentestenv']['repository'] = 'https://another/repository.git'
      node.override['pentestenv']['reference'] = 'custom'
      node.override['pentestenv']['resources'] = {
        '/root/.pentestrc' => {
          instances_path: '~/.pentest.d/instances',
          instances: ['kali'],
          targets: ['metasploitable3'],
        },
      }
    end.converge(described_recipe)
  end

  it 'syncs git[/opt/pentest-env]' do
    expect(subject).to sync_git('/opt/pentest-env')
      .with(user: 'elliot',
            group: 'root',
            repository: 'https://another/repository.git',
            reference: 'custom',
            enable_submodules: true)
  end

  it 'creates pentestenv_rc[/root/.pentestrc]' do
    expect(subject).to create_pentestenv_rc('/root/.pentestrc')
      .with(owner: 'elliot',
            group: 'root',
            cookbook: 'pentestenv',
            source: 'rc.erb',
            mode: '0644')
  end

  it 'creates cookbook_file[/opt/pentest-env/Berksfile.custom]' do
    expect(subject).to create_cookbook_file('/opt/pentest-env/Berksfile.custom')
      .with(owner: 'elliot',
            group: 'root',
            mode: '0644',
            cookbook: 'pentestenv',
            source: 'berksfiles/pentestd')
  end
end
